name: åŒæ­¥ç¬”è®°åˆ°docs

on:
  push:
    branches: [ main ]
    paths: 
      - '*.md'
      - 'agent/**/*.md'
      - 'rag/**/*.md'
      - '**/çŸ¥è¯†å›¾è°±æ„å»º.md'

jobs:
  sync-notes:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: åŒæ­¥æ‰€æœ‰ç¬”è®°æ–‡ä»¶
      run: |
        # æ¸…ç†æ—§çš„ç¬”è®°
        rm -f docs/_posts/20*.md
        
        # é€’å½’æŸ¥æ‰¾æ‰€æœ‰markdownæ–‡ä»¶ï¼ˆæ’é™¤docsç›®å½•ï¼‰
        find . -name "*.md" -not -path "./docs/*" -not -path "./.git/*" -not -name "README.md" | while read file; do
          echo "å¤„ç†æ–‡ä»¶: $file"
          
          # è·å–æ–‡ä»¶ä¿¡æ¯
          filename=$(basename "$file" .md)
          dir=$(dirname "$file" | sed 's|^\./||' | sed 's|/|-|g')  # è½¬æ¢è·¯å¾„ä¸ºæ ‡ç­¾
          date=$(date -r "$file" +%Y-%m-%d)
          
          # ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
          safe_filename=$(echo "${filename}" | sed 's/[^a-zA-Z0-9\u4e00-\u9fa5]/-/g')
          
          # åˆ›å»ºJekyllæ ¼å¼çš„æ–‡ä»¶
          post_file="docs/_posts/${date}-${dir}-${safe_filename}.md"
          
          echo "---" > "$post_file"
          echo "layout: post" >> "$post_file"
          echo "title: \"$filename\"" >> "$post_file"
          echo "date: $date" >> "$post_file"
          echo "categories: [\"$dir\"]" >> "$post_file"
          echo "tags: [\"$dir\", \"ç¬”è®°\"]" >> "$post_file"
          echo "source_path: \"$file\"" >> "$post_file"
          echo "---" >> "$post_file"
          echo "" >> "$post_file"
          
          # å¤„ç†ObsidianåŒé“¾è¯­æ³•
          sed 's/\[\[\([^]]*\)\]\]/[\1]({{ site.baseurl }}\/search\/?q=\1)/g' "$file" >> "$post_file"
          
          echo "ç”Ÿæˆ: $post_file"
        done
        
    - name: ç”Ÿæˆç¬”è®°ç´¢å¼•
      run: |
        # åˆ›å»ºåˆ†ç±»é¡µé¢
        mkdir -p docs/_pages
        
        # agentåˆ†ç±»é¡µé¢
        cat > docs/_pages/agent.md << 'EOF'
        ---
        layout: page
        title: Agentç›¸å…³ç¬”è®°
        permalink: /agent/
        ---
        
        # ğŸ¤– Agentç›¸å…³ç¬”è®°
        
        {% for post in site.categories.agent %}
        - [{{ post.title }}]({{ post.url | relative_url }}) - {{ post.date | date: "%Y-%m-%d" }}
        {% endfor %}
        EOF
        
        # ragåˆ†ç±»é¡µé¢
        cat > docs/_pages/rag.md << 'EOF'
        ---
        layout: page  
        title: RAGç›¸å…³ç¬”è®°
        permalink: /rag/
        ---
        
        # ğŸ“š RAGç›¸å…³ç¬”è®°
        
        {% for post in site.categories.rag %}
        - [{{ post.title }}]({{ post.url | relative_url }}) - {{ post.date | date: "%Y-%m-%d" }}
        {% endfor %}
        EOF
        
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/
        git commit -m "è‡ªåŠ¨åŒæ­¥ç¬”è®° $(date)" || exit 0
        git push
